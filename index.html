<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FAMAT Bubbler (pdf-lib)</title>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

  <style>
    :root{
      --bg: #0f1115;

      --panel: #141823;
      --panel2: #10141d;
      --text: #e8eaf0;
      --muted: #a7afc0;
      --line: rgba(255,255,255,0.10);
      --line2: rgba(255,255,255,0.06);
      --btn: #1d2333;
      --btnHover: #242c41;
      --accent: #7aa2ff;

      /* division pastels */
      --div1: #ffd6a5; /* Algebra I */
      --div2: #b9fbc0; /* Geometry */
      --div3: #fff3b0; /* Algebra II */
      --div4: #ffc6ff; /* Precalculus */
      --div5: #bde0fe; /* Calculus */
      --div6: #beb0e8; /* Statistics */

      --off: #2a2f3a;
      --offText: rgba(232,234,240,0.78);
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 22px;
    }

    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    h2,h3,h4{ margin: 18px 0 10px; font-weight: 650; letter-spacing: 0.2px; }
    p{ color: var(--muted); }

    .wrap{ max-width: 1050px; margin: 0 auto; }

    .panel{
      background: var(--panel);
      border: 1px solid var(--line2);
      border-radius: 12px;
      padding: 14px;
      margin: 14px 0;
    }

    .row{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    label{ color: var(--muted); }

    input[type="text"]{
      background: var(--panel2);
      color: var(--text);
      border: 1px solid var(--line2);
      border-radius: 10px;
      padding: 10px 10px;
      outline: none;
      min-width: 280px;
    }
    input[type="text"]:focus{ border-color: rgba(122,162,255,0.45); }

    textarea{
      background: var(--panel2);
      color: var(--text);
      border: 1px solid var(--line2);
      border-radius: 12px;
      padding: 12px;
      outline: none;
      width: 100%;
      min-height: 140px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.5px;
      line-height: 1.35;
    }
    textarea:focus{ border-color: rgba(122,162,255,0.45); }

    button{
      background: var(--btn);
      color: var(--text);
      border: 1px solid var(--line2);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover{ background: var(--btnHover); }
    button:active{ transform: translateY(0.5px); }

    .primary{
      background: rgba(122,162,255,0.18);
      border-color: rgba(122,162,255,0.35);
    }
    .primary:hover{ background: rgba(122,162,255,0.24); }

    .mini{
      padding: 7px 10px;
      font-weight: 650;
      border-radius: 999px;
    }

    .mutedBtn{ color: var(--muted); font-weight: 650; }

    .error{
      color: #ff9b9b;
      margin-top: 8px;
      white-space: pre-wrap;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: var(--panel2);
    }

    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line2);
      vertical-align: middle;
    }

    th{
      text-align: left;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.35px;
      background: rgba(255,255,255,0.03);
    }

    tr:last-child td{ border-bottom: none; }

    .nameCol{ min-width: 240px; }
    .idCol{ min-width: 160px; }

    span[contenteditable]{
      display: block;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid transparent;
      min-height: 34px;
    }
    span[contenteditable]:focus{
      outline: none;
      border-color: rgba(122,162,255,0.35);
      background: rgba(122,162,255,0.06);
    }

    .center{ text-align: center; }

    .includeBtn{
      user-select: none;
      font-size: 15px;
      cursor: pointer;
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,0.03);
    }
    .includeBtn:hover{ background: rgba(255,255,255,0.06); }

    .teamBtn{
      user-select: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      letter-spacing: 0.3px;
    }

    #filterBox{ display: none; }
    .smallNote{ color: var(--muted); font-size: 12px; margin-top: 8px; }

    .chips label{
      margin-right: 10px;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      user-select: none;
    }
    .chips input{ accent-color: var(--accent); }

    .divHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .divTitle{
      display: inline-block;
      margin: 0;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      font-weight: 800;
      letter-spacing: 0.2px;
      color: rgba(15,17,21,0.78);
    }
    .divTitle[data-div="1"]{ background: var(--div1); }
    .divTitle[data-div="2"]{ background: var(--div2); }
    .divTitle[data-div="3"]{ background: var(--div3); }
    .divTitle[data-div="4"]{ background: var(--div4); }
    .divTitle[data-div="5"]{ background: var(--div5); }
    .divTitle[data-div="6"]{ background: var(--div6); }
    .divTitle[data-div="0"]{ background: rgba(255,255,255,0.10); color: rgba(232,234,240,0.85); }

    /* NEW: enrollment save slot UI */
    .slotRow{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      align-items: center;
    }
    .slot{
      display:flex;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,0.03);
    }
    .slotName{
      width: 170px;
      min-width: 170px;
      background: var(--panel2);
      color: var(--text);
      border: 1px solid var(--line2);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
      font-weight: 650;
    }
    .slotName:focus{ border-color: rgba(122,162,255,0.45); }
    .danger{
      background: rgba(255, 120, 120, 0.10);
      border-color: rgba(255, 120, 120, 0.25);
    }
    .danger:hover{
      background: rgba(255, 120, 120, 0.16);
    }

    /* NEW: collapsible division styling */
    .divToggle{
      padding: 7px 10px;
      font-weight: 800;
      border-radius: 999px;
    }
    .divSummary{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: var(--panel2);
      color: var(--text);
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.5px;
      line-height: 1.35;
    }
    .divBody{ margin-top: 8px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between; align-items:flex-end;">
      <div>
        <div style="font-size:20px; font-weight:800; letter-spacing:0.2px;">FAMAT Bubbler</div>
        <div class="smallNote"><a href="https://github.com/AnirudhRahul/FAMATBubbler#tutorial">Tutorial</a></div>
      </div>
    </div>

    <form onsubmit="return false;">
      <div class="panel">
        <h4>Enrollment List</h4>
        <textarea id="enrollment" rows="8" cols="10">Roster: Berkeley Preparatory School #4050
Zhang, Sam Calculus 405000151 405000152 405000150
</textarea>

        <div class="row" style="margin-top:10px;">
          <button type="button" class="primary" onclick="readEnrollment()">Load Enrollment List</button>
          <button type="button" onclick="clearStudents()">Clear Students</button>
        </div>

        <!-- NEW: 3 local save slots -->
        <div class="smallNote" style="margin-top:10px;">
          Save up to 3 enrollment lists locally. Slots persist through refresh.
        </div>
        <div class="slotRow" id="slots"></div>
      </div>

      <div class="panel">
        <h4>School Name</h4>
        <input type="text" id="school" style="min-width: 420px;">
      </div>

      <div class="panel">
        <h4>Division Codes</h4>
        <div id="division" class="row" style="gap:12px;">
          <label>1: <input type="text" value="Algebra I" style="min-width:180px;"></label>
          <label>2: <input type="text" value="Geometry" style="min-width:180px;"></label>
          <label>3: <input type="text" value="Algebra II" style="min-width:180px;"></label>
          <label>4: <input type="text" value="Precalculus" style="min-width:180px;"></label>
          <label>5: <input type="text" value="Calculus" style="min-width:180px;"></label>
          <label>6: <input type="text" value="Statistics" style="min-width:180px;"></label>
        </div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between;">
          <h3 style="margin:0;">Student List</h3>
          <button class="mutedBtn" type="button" onclick="addRow()">+ Add Row</button>
        </div>

        <div class="smallNote">
          Team cycles: - → 1 → 2 → 3 → - (dash means no extra digit appended).<br>
          Included rows are softly tinted by division; excluded rows are dark gray.
        </div>

        <div id="studentsByDiv">
          <div class="panel" style="padding:12px; margin-top:12px;">
            <div class="divHeader">
              <h4 class="divTitle" data-div="1">Algebra I</h4>
            </div>
            <div class="divBody">
              <table><tbody id="tbodyDiv1">
                <tr>
                  <th class="nameCol">Name</th>
                  <th class="idCol">FAMAT Id (8 digits)</th>
                  <th class="center">Team</th>
                  <th class="center">Include</th>
                </tr>
              </tbody></table>
            </div>
          </div>

          <div class="panel" style="padding:12px;">
            <div class="divHeader">
              <h4 class="divTitle" data-div="2">Geometry</h4>
            </div>
            <div class="divBody">
              <table><tbody id="tbodyDiv2">
                <tr>
                  <th class="nameCol">Name</th>
                  <th class="idCol">FAMAT Id (8 digits)</th>
                  <th class="center">Team</th>
                  <th class="center">Include</th>
                </tr>
              </tbody></table>
            </div>
          </div>

          <div class="panel" style="padding:12px;">
            <div class="divHeader">
              <h4 class="divTitle" data-div="3">Algebra II</h4>
            </div>
            <div class="divBody">
              <table><tbody id="tbodyDiv3">
                <tr>
                  <th class="nameCol">Name</th>
                  <th class="idCol">FAMAT Id (8 digits)</th>
                  <th class="center">Team</th>
                  <th class="center">Include</th>
                </tr>
              </tbody></table>
            </div>
          </div>

          <div class="panel" style="padding:12px;">
            <div class="divHeader">
              <h4 class="divTitle" data-div="4">Precalculus</h4>
            </div>
            <div class="divBody">
              <table><tbody id="tbodyDiv4">
                <tr>
                  <th class="nameCol">Name</th>
                  <th class="idCol">FAMAT Id (8 digits)</th>
                  <th class="center">Team</th>
                  <th class="center">Include</th>
                </tr>
              </tbody></table>
            </div>
          </div>

          <div class="panel" style="padding:12px;">
            <div class="divHeader">
              <h4 class="divTitle" data-div="5">Calculus</h4>
            </div>
            <div class="divBody">
              <table><tbody id="tbodyDiv5">
                <tr>
                  <th class="nameCol">Name</th>
                  <th class="idCol">FAMAT Id (8 digits)</th>
                  <th class="center">Team</th>
                  <th class="center">Include</th>
                </tr>
              </tbody></table>
            </div>
          </div>

          <div class="panel" style="padding:12px;">
            <div class="divHeader">
              <h4 class="divTitle" data-div="6">Statistics</h4>
            </div>
            <div class="divBody">
              <table><tbody id="tbodyDiv6">
                <tr>
                  <th class="nameCol">Name</th>
                  <th class="idCol">FAMAT Id (8 digits)</th>
                  <th class="center">Team</th>
                  <th class="center">Include</th>
                </tr>
              </tbody></table>
            </div>
          </div>

          <div class="panel" style="padding:12px;">
            <div class="divHeader">
              <h4 class="divTitle" data-div="0">Unassigned / Invalid ID</h4>
            </div>
            <div class="divBody">
              <table><tbody id="tbodyDiv0">
                <tr>
                  <th class="nameCol">Name</th>
                  <th class="idCol">FAMAT Id (8 digits)</th>
                  <th class="center">Team</th>
                  <th class="center">Include</th>
                </tr>
              </tbody></table>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Columns to bubble</h3>
        <div id="bubbles" class="chips">
          <label><input type="checkbox" checked>1st</label>
          <label><input type="checkbox" checked>2nd</label>
          <label><input type="checkbox" checked>3rd</label>
          <label><input type="checkbox" checked>4th</label>
          <label><input type="checkbox" checked>5th</label>
          <label><input type="checkbox" checked>6th</label>
          <label><input type="checkbox" checked>7th</label>
          <label><input type="checkbox" checked>8th</label>
          <label><input type="checkbox" checked>9th</label>
        </div>

        <div class="row" style="margin-top:14px;">
          <label>Filename</label>
          <input type="text" id="filename" value="BubbledAnswerSheet" style="min-width: 320px;">
          <button class="primary" type="button" onclick="createPDF()">Create PDF</button>
        </div>

        <div class="error" id="error1"></div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between;">
          <h2 style="margin:0;">Advanced</h2>
          <button type="button" id="filterButton" class="mini" onclick="toggleFilter()">Filter ▸</button>
        </div>

        <div id="filterBox">
          <h4 style="margin-top:14px;">Input List (each student on new line)</h4>
          <textarea id="filter" rows="10" cols="10"></textarea>

          <div class="row" style="margin-top:10px;">
            <button type="button" onclick="filterStudentList()">Filter Student List</button>
          </div>
          <div class="error" id="error2"></div>

          <h4>Order</h4>
          <label><input type="radio" name="orderType" value="firstlast"> FirstName + Delimiter + LastName</label><br>
          <label><input type="radio" name="orderType" value="lastfirst"> LastName + Delimiter + FirstName</label><br>

          <h4>Delimiter</h4>
          <input type="text" id="delimiter" value="" style="min-width: 260px;"><br>

          <p class="smallNote">
            Examples:<br>
            If your list is "First, Last" delimiter is ", " and choose first ordering<br>
            If your list is "Last-First" delimiter is "-" and choose second ordering<br>
            If you want split on whitespace, set delimiter to "whitespace"
          </p>
        </div>
      </div>
    </form>
  </div>

  <script>
    // ====== CONFIG ======
    const TEMPLATE_URL = "https://codehs.com/uploads/c689f24e55293b7e0d01e2af65f89515";

    // localStorage save slots
    const ENROLLMENT_SLOT_KEY = "famatbubbler.enrollmentSlots.v1";
    const SLOT_COUNT = 3;

    // ====== UI state ======
    const ICON_ON  = "✅";
    const ICON_OFF = "❌";

    // Use stable rowIds (NOT table row indices)
    let nextRowId = 1;
    const green = { 0: true }; // green[rowId] = include?
    const team  = { 0: 0 };    // team[rowId]  in {0,1,2,3} where 0 means "-"

    const tbodyForDiv = {
      0: () => document.getElementById("tbodyDiv0"),
      1: () => document.getElementById("tbodyDiv1"),
      2: () => document.getElementById("tbodyDiv2"),
      3: () => document.getElementById("tbodyDiv3"),
      4: () => document.getElementById("tbodyDiv4"),
      5: () => document.getElementById("tbodyDiv5"),
      6: () => document.getElementById("tbodyDiv6"),
    };

    const divColorVar = {
      1: "var(--div1)",
      2: "var(--div2)",
      3: "var(--div3)",
      4: "var(--div4)",
      5: "var(--div5)",
      6: "var(--div6)",
    };

    let filterVisible = false;
    function toggleFilter(){
      const box = document.getElementById("filterBox");
      filterVisible = !filterVisible;
      box.style.display = filterVisible ? "block" : "none";
      document.getElementById("filterButton").innerText = filterVisible ? "Filter ▾" : "Filter ▸";
      if (filterVisible) window.scrollTo(0, 100000);
    }

    function teamLabel(v){
      return (v === 1 || v === 2 || v === 3) ? String(v) : "-";
    }

    function teamDigit(v){
      return (v === 1 || v === 2 || v === 3) ? String(v) : "";
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeId8(raw){
      const digits = String(raw ?? "").replaceAll(/\D/g, "");
      return digits.substring(0, 8);
    }

    function divisionFromId8(id8){
      if (!id8 || id8.length !== 8) return 0;
      const d = id8.charCodeAt(7) - "0".charCodeAt(0);
      return (d >= 1 && d <= 6) ? d : 0;
    }

    // ====== NEW: collapsible divisions + summaries ======
    function getDivisionPanelByDiv(div){
      const title = document.querySelector(`.divTitle[data-div="${div}"]`);
      return title ? title.closest('.panel') : null;
    }

    function ensureDivisionSummaryEl(panel){
      if (!panel) return null;
      let sum = panel.querySelector(".divSummary");
      if (!sum){
        sum = document.createElement("pre");
        sum.className = "divSummary";
        // Insert before .divBody
        const body = panel.querySelector(".divBody");
        if (body) panel.insertBefore(sum, body);
        else panel.appendChild(sum);
      }
      return sum;
    }

    function setDivisionCollapsed(div, collapsed){
      const panel = getDivisionPanelByDiv(div);
      if (!panel) return;

      panel.dataset.collapsed = collapsed ? "1" : "0";

      const body = panel.querySelector(".divBody");
      const sum  = ensureDivisionSummaryEl(panel);

      if (collapsed){
        if (body) body.style.display = "none";
        if (sum) sum.style.display = "block";
      } else {
        if (body) body.style.display = "block";
        if (sum) sum.style.display = "none";
      }

      const btn = panel.querySelector(".divToggle");
      if (btn) btn.textContent = collapsed ? "Expand ▸" : "Collapse ▾";
    }

    function isDivisionCollapsed(div){
      const panel = getDivisionPanelByDiv(div);
      return panel ? (panel.dataset.collapsed === "1") : false;
    }

    function toggleDivision(div){
      setDivisionCollapsed(div, !isDivisionCollapsed(div));
    }

    function updateDivisionSummary(div){
      const panel = getDivisionPanelByDiv(div);
      if (!panel) return;

      const sum = ensureDivisionSummaryEl(panel);
      if (!sum) return;

      const rows = Array.from(document.querySelectorAll(`tr[data-rowid][data-division="${div}"]`))
        .map(tr => {
          const rowId = Number(tr.dataset.rowid);
          const nameSpan = tr.querySelector("span.nameCol");
          const name = (nameSpan ? nameSpan.innerText : "").trim();
          return { tr, rowId, name };
        })
        .filter(x => !!green[x.rowId]); // included only

      const t1 = [];
      const t2 = [];
      const t3 = [];
      const t0 = [];

      for (const r of rows){
        const tv = team[r.rowId] || 0;
        if (tv === 1) t1.push(r.name);
        else if (tv === 2) t2.push(r.name);
        else if (tv === 3) t3.push(r.name);
        else t0.push(r.name);
      }

      // stable-ish, but nice: alphabetical within each team
      t1.sort((a,b)=>a.localeCompare(b));
      t2.sort((a,b)=>a.localeCompare(b));
      t3.sort((a,b)=>a.localeCompare(b));
      t0.sort((a,b)=>a.localeCompare(b));

      function namesOrNone(arr){
        return arr.length ? arr.join(", ") : "None";
      }

      const lines = [];
      lines.push(`Team 1 [${t1.length}/4] \u2013 ${namesOrNone(t1)}`);
      lines.push(`Team 2 [${t2.length}/4] \u2013 ${namesOrNone(t2)}`);
      lines.push(`Team 3 [${t3.length}/4] \u2013 ${namesOrNone(t3)}`);
      lines.push(`No Team [${t0.length}] \u2013 ${namesOrNone(t0)}`);

      sum.textContent = lines.join("\n");
    }

    function updateAllDivisionSummaries(){
      for (const d of [1,2,3,4,5,6,0]) updateDivisionSummary(d);
    }

    function setupDivisionCollapsers(){
      const titles = Array.from(document.querySelectorAll(".divTitle[data-div]"));
      for (const t of titles){
        const div = Number(t.dataset.div);
        const panel = t.closest(".panel");
        if (!panel) continue;

        const header = panel.querySelector(".divHeader");
        if (!header) continue;

        if (!header.querySelector(".divToggle")){
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "mini divToggle";
          btn.addEventListener("click", () => toggleDivision(div));
          header.appendChild(btn);
        }

        // Default: collapsed on refresh
        setDivisionCollapsed(div, true);
        updateDivisionSummary(div);

        // Make the title itself clickable for one-click expand/collapse
        t.style.cursor = "pointer";
        t.title = "Click to expand/collapse";
        t.addEventListener("click", () => toggleDivision(div));
      }
    }

    // ====== local save slots (enrollment textarea) ======
    function safeParseJson(s, fallback){
      try{ return JSON.parse(s); } catch { return fallback; }
    }

    function defaultSlots(){
      return Array.from({length: SLOT_COUNT}, (_, i) => ({
        name: `Slot ${i+1}`,
        text: ""
      }));
    }

    function loadSlots(){
      const raw = localStorage.getItem(ENROLLMENT_SLOT_KEY);
      const slots = safeParseJson(raw, null);
      if (!Array.isArray(slots) || slots.length !== SLOT_COUNT) return defaultSlots();
      return slots.map((x, i) => ({
        name: String(x?.name ?? `Slot ${i+1}`).slice(0, 40),
        text: String(x?.text ?? "")
      }));
    }

    function saveSlots(slots){
      localStorage.setItem(ENROLLMENT_SLOT_KEY, JSON.stringify(slots));
    }

    function renderSlots(){
      const host = document.getElementById("slots");
      if (!host) return;

      const slots = loadSlots();
      host.innerHTML = "";

      slots.forEach((slot, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "slot";

        const name = document.createElement("input");
        name.className = "slotName";
        name.type = "text";
        name.value = slot.name;
        name.title = "Rename this slot";
        name.addEventListener("input", () => {
          const s = loadSlots();
          s[idx].name = name.value;
          saveSlots(s);
        });

        const btnSave = document.createElement("button");
        btnSave.type = "button";
        btnSave.textContent = "Save";
        btnSave.title = "Save current Enrollment List into this slot";
        btnSave.addEventListener("click", () => {
          const s = loadSlots();
          s[idx].text = document.getElementById("enrollment").value || "";
          saveSlots(s);
          renderSlots();
        });

        const btnLoad = document.createElement("button");
        btnLoad.type = "button";
        btnLoad.textContent = "Load";
        btnLoad.className = "primary";
        btnLoad.title = "Load this slot into the Enrollment List box";
        btnLoad.addEventListener("click", () => {
          clearStudents();
          const s = loadSlots();
          document.getElementById("enrollment").value = s[idx].text || "";
          readEnrollment();
        });

        const btnClear = document.createElement("button");
        btnClear.type = "button";
        btnClear.textContent = "Clear";
        btnClear.className = "danger";
        btnClear.title = "Clear the saved text in this slot";
        btnClear.addEventListener("click", () => {
          const s = loadSlots();
          s[idx].text = "";
          saveSlots(s);
          renderSlots();
        });

        const meta = document.createElement("span");
        meta.style.color = "var(--muted)";
        meta.style.fontSize = "12px";
        meta.style.marginLeft = "4px";
        const lines = (slot.text || "").split("\n").filter(Boolean).length;
        meta.textContent = slot.text ? `${lines} line${lines===1?"":"s"} saved` : "empty";

        wrap.appendChild(name);
        wrap.appendChild(btnSave);
        wrap.appendChild(btnLoad);
        wrap.appendChild(btnClear);
        wrap.appendChild(meta);

        host.appendChild(wrap);
      });
    }

    // ====== tint logic (white text + low opacity pastel by team) ======
    function tintAlphaForTeam(teamVal){
      if (teamVal === 1) return 0.35;
      if (teamVal === 2) return 0.28;
      if (teamVal === 3) return 0.21;
      return 0.14; // no team
    }

    function parseCssColorToRgb(cssColor){
      const c = String(cssColor || "").trim();

      if (c.startsWith("rgb(") || c.startsWith("rgba(")){
        const nums = c.replace(/^rgba?\(|\)$/g, "").split(",").map(x => x.trim());
        const r = parseFloat(nums[0]), g = parseFloat(nums[1]), b = parseFloat(nums[2]);
        if ([r,g,b].some(v => Number.isNaN(v))) return null;
        return { r, g, b };
      }

      if (c.startsWith("#")){
        const hex = c.slice(1);
        if (hex.length === 3){
          const r = parseInt(hex[0] + hex[0], 16);
          const g = parseInt(hex[1] + hex[1], 16);
          const b = parseInt(hex[2] + hex[2], 16);
          return { r, g, b };
        }
        if (hex.length === 6){
          const r = parseInt(hex.slice(0,2), 16);
          const g = parseInt(hex.slice(2,4), 16);
          const b = parseInt(hex.slice(4,6), 16);
          return { r, g, b };
        }
      }

      return null;
    }

    function setRowColors(tr, rowId){
      const included = !!green[rowId];
      const div = Number(tr.dataset.division || "0");

      if (!included){
        tr.style.backgroundColor = "var(--off)";
        tr.style.color = "var(--offText)";
        return;
      }

      const alpha = tintAlphaForTeam(team[rowId]);
      const varOrFallback = divColorVar[div] || "rgba(255,255,255,0.06)";

      const resolved = (varOrFallback.startsWith("var("))
        ? getComputedStyle(document.documentElement).getPropertyValue(varOrFallback.slice(4, -1)).trim()
        : varOrFallback;

      const rgb = parseCssColorToRgb(resolved) || parseCssColorToRgb(varOrFallback);

      tr.style.color = "var(--text)";
      if (rgb){
        tr.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
      } else {
        tr.style.backgroundColor = `rgba(255,255,255,${Math.min(alpha, 0.12)})`;
      }
    }

    function moveRowToDivision(tr, newDiv){
      const oldDiv = Number(tr.dataset.division || "0");
      if (oldDiv === newDiv) return;

      tr.dataset.division = String(newDiv);

      const tbody = tbodyForDiv[newDiv] ? tbodyForDiv[newDiv]() : tbodyForDiv[0]();
      tbody.appendChild(tr);

      // keep summaries correct
      updateDivisionSummary(oldDiv);
      updateDivisionSummary(newDiv);
    }

    function onIdEdit(rowId){
      const tr = document.querySelector(`tr[data-rowid="${rowId}"]`);
      if (!tr) return;

      const idSpan = tr.querySelector("span.idCol");
      const id8 = normalizeId8(idSpan ? idSpan.innerText : "");
      const div = divisionFromId8(id8);

      moveRowToDivision(tr, div);
      setRowColors(tr, rowId);

      updateDivisionSummary(Number(tr.dataset.division || "0"));
    }

    function addRow(name="", id8=""){
      const rowId = nextRowId++;
      green[rowId] = false;
      team[rowId] = 0;

      const div = divisionFromId8(normalizeId8(id8));
      const tbody = tbodyForDiv[div] ? tbodyForDiv[div]() : tbodyForDiv[0]();

      const tr = document.createElement("tr");
      tr.dataset.rowid = String(rowId);
      tr.dataset.division = String(div);

      tr.innerHTML =
        `<td><span class="nameCol" contenteditable>${escapeHtml(name)}</span></td>` +
        `<td><span class="idCol" contenteditable>${escapeHtml(id8)}</span></td>` +
        `<td class="center">
            <button type="button" class="teamBtn" onclick="cycleTeam(${rowId})">${teamLabel(0)}</button>
         </td>` +
        `<td class="center">
            <span class="includeBtn" onclick="toggleRow(${rowId})">${ICON_OFF}</span>
         </td>`;

      tbody.appendChild(tr);

      const idSpan = tr.querySelector("span.idCol");
      idSpan.addEventListener("input", () => onIdEdit(rowId));
      idSpan.addEventListener("blur",  () => onIdEdit(rowId));

      // Update summary when name changes
      const nameSpan = tr.querySelector("span.nameCol");
      nameSpan.addEventListener("input", () => updateDivisionSummary(Number(tr.dataset.division || "0")));
      nameSpan.addEventListener("blur",  () => updateDivisionSummary(Number(tr.dataset.division || "0")));

      setRowColors(tr, rowId);
      updateDivisionSummary(div);
    }

    function cycleTeam(rowId){
      team[rowId] = (team[rowId] + 1) % 4;
      const tr = document.querySelector(`tr[data-rowid="${rowId}"]`);
      if (!tr) return;

      const btn = tr.querySelector("button.teamBtn");
      if (btn) btn.textContent = teamLabel(team[rowId]);

      setRowColors(tr, rowId);

      updateDivisionSummary(Number(tr.dataset.division || "0"));
    }

    function toggleRow(rowId){
      green[rowId] = !green[rowId];

      const tr = document.querySelector(`tr[data-rowid="${rowId}"]`);
      if (!tr) return;

      const btn = tr.querySelector("span.includeBtn");
      if (btn) btn.textContent = green[rowId] ? ICON_ON : ICON_OFF;

      setRowColors(tr, rowId);

      updateDivisionSummary(Number(tr.dataset.division || "0"));
    }

    function allStudentRows(){
      return Array.from(document.querySelectorAll('tr[data-rowid]'));
    }

    function clearStudents(){
      for (const tr of allStudentRows()){
        tr.remove();
      }
      nextRowId = 1;
      for (const k of Object.keys(green)) if (k !== "0") delete green[k];
      for (const k of Object.keys(team))  if (k !== "0") delete team[k];

      updateAllDivisionSummaries();
    }

    // ====== Enrollment parsing ======
    function readEnrollment(){
      const text = document.getElementById("enrollment").value;
      const lines = text.split("\n").map(s => s.trim()).filter(Boolean);

      for (const line of lines){
        const m = line.match(/^(?:Enrollment list for:|Roster:)\s*(.*?)\s*#\s*\d+/i);
        if (m){
          document.getElementById("school").value = m[1].trim();
          break;
        }
      }

      const studentRe = /^([^,]+),\s*([A-Za-z' -]+)\s+(Algebra I|Algebra II|Geometry|Precalculus|Calculus|Statistics)\b/i;

      for (const line of lines){
        if (/^Student Name\b/i.test(line)) continue;
        if (/^(Enrollment list for:|Roster:)/i.test(line)) continue;

        const sm = line.match(studentRe);
        if (!sm) continue;

        const last = sm[1].trim();
        const first = sm[2].trim();

        const parts = line.split(/\s+/);
        if (parts.length < 4) continue;

        const last3 = parts.slice(-3).join("");
        const idDigits = last3.replaceAll(/\D/g, "");
        const id8 = idDigits.substring(0, 8);

        addRow(`${first} ${last}`, id8);
      }

      updateAllDivisionSummaries();
    }

    // ====== Filtering ======
    function getOrder(){
      const radios = document.getElementsByName("orderType");
      for (let i = 0; i < radios.length; i++){
        if (radios[i].checked) return radios[i].value;
      }
      return null;
    }

    function clearAllRowsToExcluded(){
      for (const tr of allStudentRows()){
        const rowId = Number(tr.dataset.rowid);
        if (green[rowId]) toggleRow(rowId);
      }
    }

    function filterStudentList(){
      const error2 = document.getElementById("error2");
      error2.textContent = "";

      const delimiter = document.getElementById("delimiter").value;
      const order = getOrder();
      if (!order){
        error2.textContent = "Error: choose an order.\n";
        return;
      }
      if (!delimiter){
        error2.textContent = "Error: provide a delimiter (or \"whitespace\").\n";
        return;
      }

      clearAllRowsToExcluded();

      const text = document.getElementById("filter").value.trim();
      const lines = text ? text.split("\n").map(s => s.trim()).filter(Boolean) : [];

      const notMatched = [];

      for (const line of lines){
        let split = (delimiter === "whitespace") ? line.split(/\s+/) : line.split(delimiter);
        split = split.map(s => s.trim()).filter(Boolean);
        if (split.length < 2){
          notMatched.push(line);
          continue;
        }

        const toMatch = (order === "firstlast")
          ? `${split[0]} ${split[1]}`
          : `${split[1]} ${split[0]}`;

        let found = false;

        for (const tr of allStudentRows()){
          const rowId = Number(tr.dataset.rowid);
          const nameSpan = tr.querySelector("span.nameCol");
          const studentName = nameSpan ? nameSpan.innerText.trim() : "";
          if (studentName.toLowerCase() === toMatch.toLowerCase()){
            if (!green[rowId]) toggleRow(rowId);
            found = true;
            break;
          }
        }

        if (!found) notMatched.push(line);
      }

      if (notMatched.length){
        error2.textContent += "Did not match:\n" + notMatched.join("\n") + "\n";
      }

      updateAllDivisionSummaries();
    }

    // ====== PDF overlay (pdf-lib) ======
    function yFlip(page, yFromTop){
      return page.getHeight() - yFromTop;
    }

    function drawName(page, font, text){
      page.drawText(text ?? "", { x: 169.7, y: yFlip(page, 111.3), size: 11.5, font });
    }
    function drawSchool(page, font, text){
      page.drawText(text ?? "", { x: 169.7, y: yFlip(page, 131.5), size: 11.5, font });
    }
    function drawTest(page, font, text){
      page.drawText(text ?? "", { x: 169.7, y: yFlip(page, 151.9), size: 11.5, font });
    }

    function drawID(page, font, id9, bubbles) {
      const { rgb } = PDFLib;

      const CALIBRATE = false;

      const DIG = {
        startX: 106,
        stepX: 17,
        useManualX: true,
        manualX: [105.6, 122.29, 138.98, 156, 173.02, 189.37, 206.05, 223.4, 240.64],
        yFromTop: 214.7,
        size: 18,
      };

      const BUB = {
        startX: 110.74,
        stepX: 17.01,
        useManualX: false,
        manualX: [110, 127, 144, 161, 178, 195, 212, 229, 246],
        yZeroFromTop: 211 + 19.6,
        stepY: 15.36,
        nudgeY: 0,
        perColNudgeX: [0.1, 0, -0.6, -0.9, -0.5, -1, -1.8, -1.8, -1],
        radius: 6.63,
      };

      function digitX(i) {
        return DIG.useManualX ? DIG.manualX[i] : DIG.startX + DIG.stepX * i;
      }
      function bubbleX(i) {
        const base = BUB.useManualX ? BUB.manualX[i] : BUB.startX + BUB.stepX * i;
        const nudge = BUB.perColNudgeX?.[i] ?? 0;
        return base + nudge;
      }
      function drawCrosshair(x, y, size = 4) {
        page.drawLine({ start: { x: x - size, y }, end: { x: x + size, y }, thickness: 0.6, color: rgb(1,0,0), opacity: 0.6 });
        page.drawLine({ start: { x, y: y - size }, end: { x, y: y + size }, thickness: 0.6, color: rgb(1,0,0), opacity: 0.6 });
      }

      for (let i = 0; i < id9.length && i < 9; i++) {
        if (!bubbles[i]) continue;

        const ch = id9.charAt(i);

        const dx = digitX(i);
        const dy = yFlip(page, DIG.yFromTop);

        page.drawText(ch, { x: dx, y: dy, size: DIG.size, font, color: rgb(0, 0, 0) });
        if (CALIBRATE) drawCrosshair(dx + 5.4, dy + 5.6);

        const digit = ch.charCodeAt(0) - "0".charCodeAt(0);
        if (digit < 0 || digit > 9) continue;

        const bx = bubbleX(i);
        const byFromTop = BUB.yZeroFromTop + BUB.stepY * digit + BUB.nudgeY;
        const by = yFlip(page, byFromTop);

        page.drawCircle({ x: bx, y: by, size: BUB.radius, color: rgb(0, 0, 0), opacity: 0.75 });
        if (CALIBRATE) drawCrosshair(bx, by);
      }
    }

    function drawPage(page, font, idFont, studentName, id9, school, tests, bubbles){
      const idx = (id9.charAt(7).charCodeAt(0) - "1".charCodeAt(0));
      const division = tests[idx] || "";
      drawName(page, font, studentName);
      drawSchool(page, font, school);
      drawTest(page, font, division);
      drawID(page, idFont, id9, bubbles);
    }

    async function fetchTemplatePdfBytes(){
      const resp = await fetch(TEMPLATE_URL);
      if (!resp.ok) throw new Error("Template fetch failed: HTTP " + resp.status);

      const bytes = await resp.arrayBuffer();
      const head = new TextDecoder().decode(new Uint8Array(bytes.slice(0, 5)));
      if (head !== "%PDF-") throw new Error("Template did not load as a PDF. Got: " + head);

      return bytes;
    }

    async function createPDF(){
      const error1 = document.getElementById("error1");
      error1.textContent = "";

      try{
        const { PDFDocument, StandardFonts } = PDFLib;

        const templateBytes = await fetchTemplatePdfBytes();
        const templateDoc = await PDFDocument.load(templateBytes);

        const outDoc = await PDFDocument.create();
        const font = await outDoc.embedFont(StandardFonts.Helvetica);
        const idFont = await outDoc.embedFont(StandardFonts.Courier);

        const school = document.getElementById("school").value || "";

        const bubbles = [];
        const bubbleInputs = document.getElementById("bubbles").getElementsByTagName("input");
        for (let i = 0; i < 9; i++) bubbles.push(bubbleInputs[i].checked);

        const tests = [];
        const testInputs = document.getElementById("division").getElementsByTagName("input");
        for (let i = 0; i < 6; i++) tests.push(testInputs[i].value);

        const filename = (document.getElementById("filename").value || "BubbledAnswerSheet") + ".pdf";

        let pagesMade = 0;

        for (const tr of allStudentRows()){
          const rowId = Number(tr.dataset.rowid);
          if (!green[rowId]) continue;

          const nameSpan = tr.querySelector("span.nameCol");
          const idSpan   = tr.querySelector("span.idCol");

          const studentName = (nameSpan ? nameSpan.innerText : "").trim();
          const id8 = normalizeId8(idSpan ? idSpan.innerText : "");
          if (id8.length !== 8){
            error1.textContent += `Row (ID ${rowId}): invalid ID (need 8 digits)\n`;
            continue;
          }

          const id9 = id8 + teamDigit(team[rowId]);

          const [page] = await outDoc.copyPages(templateDoc, [0]);
          outDoc.addPage(page);

          drawPage(page, font, idFont, studentName, id9, school, tests, bubbles);
          pagesMade++;
        }

        if (pagesMade === 0){
          error1.textContent = "No pages generated. Make sure rows are included (✅) and IDs are valid.\n";
          return;
        }

        const outBytes = await outDoc.save();
        const blob = new Blob([outBytes], { type: "application/pdf" });
        const outUrl = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = outUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(outUrl);

      } catch (err){
        error1.textContent = String(err) + "\n";
      }
    }

    // On load: render slots + add collapsers (collapsed by default)
    document.addEventListener("DOMContentLoaded", () => {
      renderSlots();
      setupDivisionCollapsers();
      updateAllDivisionSummaries();
    });
  </script>
</body>
</html>
